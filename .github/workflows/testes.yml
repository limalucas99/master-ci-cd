name: Execução de Testes
on:
    workflow_call:
jobs:
    unit-test:
        name: Testes de Unidade
        runs-on: ubuntu-latest
        steps:
          - name: Obtendo o código do projeto
            uses: actions/checkout@v4
          - name: Setup dotnet
            uses: actions/setup-dotnet@v4
            with:
              dotnet-version: "8.0.300"
          - name: Execução do Teste de unidade
            working-directory: ./src
            run: dotnet test ./Review-Filmes.Test.Unit/Review-Filmes.Test.Unit.csproj
            
    integration-test:
        name: Testes de Integração
        runs-on: ubuntu-latest
        services:
          postgres:
            image: postgres:latest
            ports:
                - 5432:5432
            env:
                POSTGRES_USER: review
                POSTGRES_PASSWORD: postgrespwd
                POSTGRES_DB: review-filmes
        steps:
          - name: Obtendo o código do projeto
            uses: actions/checkout@v4
          - name: Setup dotnet
            uses: actions/setup-dotnet@v4
            with:
              dotnet-version: "8.0.300"
          - name: Execução do Teste de Integração
            working-directory: ./src
            run: dotnet test ./Review-Filmes.Test.Integration/Review-Filmes.Test.Integration.csproj
            env: 
              ConnectionStrings__DefaultConnection: "Host=localhost;Database=review-filmes;Username=review;Password=postgrespwd"
    sonarqube:
        name: Scan com o Sonarqube
        runs-on: ubuntu-latest
        steps:
          - name: Obtendo o código do projeto
            uses: actions/checkout@v4

          - name: Setup dotnet
            uses: actions/setup-dotnet@v4
            with:
              dotnet-version: "8.0.300"

          - name: Install SonarScanner for .NET
            run: dotnet tool install --global dotnet-sonarscanner

          - name: Begin SonarQube analysis
            env:
              SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
            run: |
              echo "Starting SonarScanner..."
              dotnet sonarscanner begin \
                /k:"limalucas99_master-ci-cd" \
                /o:"limalucas99" \
                /d:sonar.login=${SONAR_TOKEN} \
                /d:sonar.host.url="https://sonarcloud.io"

                
          - name: Build project
            working-directory: ./src
            run: dotnet build Review-Filmes.sln

          - name: End SonarCloud Analysis
            env:
              SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
            run: |
              dotnet sonarscanner end \
                /d:sonar.login=${SONAR_TOKEN}

